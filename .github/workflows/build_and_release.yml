name: Build and Release

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.8.1'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw'
        modules: 'qtmultimedia'
        dir: '${{ github.workspace }}/qt/'
        install-deps: 'true'
        cache: 'true'

    - name: Configure CMake
      run: cmake -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}"

    - name: Build
      run: cmake --build build --config Release

    - name: Run Tests
      working-directory: build
      run: ctest -C Release --output-on-failure

    - name: Deploy Qt Dependencies
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Find the actual executable name dynamically.
        $exe = Get-ChildItem -Path build -Recurse -Filter "*.exe" | Where-Object { $_.Name -notlike "*test*" } | Select-Object -First 1
        Write-Host "Found executable: $($exe.FullName)"
        
        mkdir dist
        Copy-Item $exe.FullName -Destination dist/
        
        windeployqt --release --compiler-runtime dist/$($exe.Name)

    - name: Create Single EXE (SFX)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        # Create a self-extracting archive using 7z
        7z a -sfx MindLeap_Single.exe ./dist/*

    - name: Zip Release
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        Compress-Archive -Path dist/*,MindLeap_Single.exe -DestinationPath Release.zip

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Release.zip
          MindLeap_Single.exe
